% FUNCTION
% Compute_L.m
%__________________________________________________________________________
%
% PURPOSE
% Computation of the generalised muscle lever arms
% Computation of muscles length and velocity
%
% SYNOPSIS
% (Segment,Model) = Compute_L(Segment,Model,freq)
%
% INPUT
% Segment (cf. data structure in user guide)
% Model (cf. data structure in user guide)
% f (i.e., sampling frequency)
%
% OUTPUT
% Segment (cf. data structure in user guide)
% Model (cf. data structure in user guide)
%
% DESCRIPTION
% Definition of the virtuels markers for all origin, via and insertion of
% muscles and computation of the lever arms, the muscle length and velocity
%
% REFERENCES
%__________________________________________________________________________
%
% CALLED FUNCTIONS (FROM MUSCULO-SKELETAL TOOLBOX)
% Mprod_array3.m
% Vnorm_array3.m
%
% MATLAB VERSION
% Matlab R2011b
%__________________________________________________________________________
%
% CHANGELOG
% Created by Florent Moissenet, Raphael Dumas
% July 2013
%
% Modified by Florent Moissenent
% July 2013
% Computation of muscles length and velocity
% Modification of virtual marker numbering
%
%__________________________________________________________________________

function [Segment,Model] = Compute_L_Delp(Segment,Model,f,weight)

% Number of frames
n = size(Segment(2).rM,3);

% -------------------------------------------------------------------------
% Geometry length (data from Opensim)
% -------------------------------------------------------------------------
% Lm(2) not used: length in meter of foot segment
Lm(3) = 0.4260; % Length in meter of shank segment
% Lm(4) not used: length in meter of patella segment
Lm(5) = 0.3960; % Length in meter of thigh segment
% Lm(6) = 0.1069; % Length in meter of pelvis segment (computed using regressions for HJC and LJC)
Lm(6) = Segment(6).L; % No scaling

% -------------------------------------------------------------------------
% Optimal isometric length (m) (Delp 1990)
% -------------------------------------------------------------------------
scaleRatio = mean([(Segment(3).L/Lm(3)),(Segment(5).L/Lm(5))]); % Shank and thigh
Model.L0(1,1) = 0.14200000 * scaleRatio;     % Gluteus maximus I
Model.L0(2,1) = 0.14700000 * scaleRatio;     % Gluteus maximus II
Model.L0(3,1) = 0.14400000 * scaleRatio;     % Gluteus maximus III
Model.L0(4,1) = 0.05350000 * scaleRatio;     % Gluteus medius I
Model.L0(5,1) = 0.08450000 * scaleRatio;     % Gluteus medius II
Model.L0(6,1) = 0.06460000 * scaleRatio;     % Gluteus medius III
Model.L0(7,1) = 0.06800000 * scaleRatio;     % Gluteus minimus I
Model.L0(8,1) = 0.05600000 * scaleRatio;     % Gluteus minimus II
Model.L0(9,1) = 0.03800000 * scaleRatio;     % Gluteus minimus III
Model.L0(10,1) = 0.13800000 * scaleRatio;    % Adductor longus
Model.L0(11,1) = 0.13300000 * scaleRatio;    % Adductor brevis
Model.L0(12,1) = 0.08700000 * scaleRatio;    % Adductor magnus I
Model.L0(13,1) = 0.12100000 * scaleRatio;    % Adductor magnus II
Model.L0(14,1) = 0.13100000 * scaleRatio;    % Adductor magnus III
Model.L0(15,1) = 0.13300000 * scaleRatio;    % Pectineus
Model.L0(16,1) = 0.10000000 * scaleRatio;    % Iliacus
Model.L0(17,1) = 0.10400000 * scaleRatio;    % Psoas
Model.L0(18,1) = 0.05400000 * scaleRatio;    % Quadratus femoris
Model.L0(19,1) = 0.02400000 * scaleRatio;    % Gemelli
Model.L0(20,1) = 0.02600000 * scaleRatio;    % Piriformis
Model.L0(21,1) = 0.09500000 * scaleRatio;    % Tensor fascia lata
Model.L0(22,1) = 0.35200000 * scaleRatio;    % Gracilis 
Model.L0(23,1) = 0.57900000 * scaleRatio;    % Sartorius
Model.L0(24,1) = 0.08000000 * scaleRatio;    % Semimembranosus
Model.L0(25,1) = 0.20100000 * scaleRatio;    % Semitendinosus
Model.L0(26,1) = 0.10900000 * scaleRatio;    % Biceps femoris long head
Model.L0(27,1) = 0.17300000 * scaleRatio;    % Biceps femoris short head
Model.L0(28,1) = 0.08400000 * scaleRatio;    % Rectus femoris
Model.L0(29,1) = 0.08900000 * scaleRatio;    % Vastus medialis
Model.L0(30,1) = 0.08700000 * scaleRatio;    % Vastus intermedius
Model.L0(31,1) = 0.08400000 * scaleRatio;    % Vastus lateralis
Model.L0(32,1) = 0.04500000 * scaleRatio;    % Gastrocnemius medialis
Model.L0(33,1) = 0.06400000 * scaleRatio;    % Gastrocnemius lateralis
Model.L0(34,1) = 0.03000000 * scaleRatio;    % Soleus
Model.L0(35,1) = 0.03100000 * scaleRatio;    % Tibialis posterior
Model.L0(36,1) = 0.09800000 * scaleRatio;    % Tibialis anterior
Model.L0(37,1) = 0.05000000 * scaleRatio;    % Peroneus brevis
Model.L0(38,1) = 0.04900000 * scaleRatio;    % Peroneus longus
Model.L0(39,1) = 0.07900000 * scaleRatio;    % Peroneus tertius
Model.L0(40,1) = 0.10200000 * scaleRatio;    % Extensor digitorum longus
Model.L0(41,1) = 0.11100000 * scaleRatio;    % Extensor hallucis longus
Model.L0(42,1) = 0.03400000 * scaleRatio;    % Flexor digitorum longus
Model.L0(43,1) = 0.04300000 * scaleRatio;    % Flexor hallucis longus

% -------------------------------------------------------------------------
% Maximum contraction velocity of the fibers, in optimal fiberlengths
% per second (m/sec) (Delp 1990)
% -------------------------------------------------------------------------
for i = 1:43
    Model.V0max(i,1) = 10.00000000 * Model.L0(i,1);
end

% -------------------------------------------------------------------------
% Tendon slack length (m) (Delp 1990)
% -------------------------------------------------------------------------
scaleRatio = mean([(Segment(3).L/Lm(3)),(Segment(5).L/Lm(5))]); % Shank and thigh
Model.Lts(1,1) = 0.12500000 * scaleRatio;     % Gluteus maximus I
Model.Lts(2,1) = 0.12700000 * scaleRatio;     % Gluteus maximus II
Model.Lts(3,1) = 0.14500000 * scaleRatio;     % Gluteus maximus III
Model.Lts(4,1) = 0.07800000 * scaleRatio;     % Gluteus medius I
Model.Lts(5,1) = 0.05300000 * scaleRatio;     % Gluteus medius II
Model.Lts(6,1) = 0.05300000 * scaleRatio;     % Gluteus medius III
Model.Lts(7,1) = 0.01600000 * scaleRatio;     % Gluteus minimus I
Model.Lts(8,1) = 0.02600000 * scaleRatio;     % Gluteus minimus II
Model.Lts(9,1) = 0.05100000 * scaleRatio;     % Gluteus minimus III
Model.Lts(10,1) = 0.11000000 * scaleRatio;    % Adductor longus
Model.Lts(11,1) = 0.02000000 * scaleRatio;    % Adductor brevis
Model.Lts(12,1) = 0.06000000 * scaleRatio;    % Adductor magnus I
Model.Lts(13,1) = 0.13000000 * scaleRatio;    % Adductor magnus II
Model.Lts(14,1) = 0.26000000 * scaleRatio;    % Adductor magnus III
Model.Lts(15,1) = 0.00100000 * scaleRatio;    % Pectineus
Model.Lts(16,1) = 0.09000000 * scaleRatio;    % Iliacus
Model.Lts(17,1) = 0.13000000 * scaleRatio;    % Psoas
Model.Lts(18,1) = 0.02400000 * scaleRatio;    % Quadratus femoris
Model.Lts(19,1) = 0.03900000 * scaleRatio;    % Gemelli
Model.Lts(20,1) = 0.11500000 * scaleRatio;    % Piriformis
Model.Lts(21,1) = 0.42500000 * scaleRatio;    % Tensor fascia lata
Model.Lts(22,1) = 0.14000000 * scaleRatio;    % Gracilis 
Model.Lts(23,1) = 0.04000000 * scaleRatio;    % Sartorius
Model.Lts(24,1) = 0.35900000 * scaleRatio;    % Semimembranosus
Model.Lts(25,1) = 0.26200000 * scaleRatio;    % Semitendinosus
Model.Lts(26,1) = 0.34100000 * scaleRatio;    % Biceps femoris long head
Model.Lts(27,1) = 0.10000000 * scaleRatio;    % Biceps femoris short head
Model.Lts(28,1) = 0.34600000 * scaleRatio;    % Rectus femoris
Model.Lts(29,1) = 0.12600000 * scaleRatio;    % Vastus medialis
Model.Lts(30,1) = 0.13600000 * scaleRatio;    % Vastus intermedius
Model.Lts(31,1) = 0.15700000 * scaleRatio;    % Vastus lateralis
Model.Lts(32,1) = 0.40800000 * scaleRatio;    % Gastrocnemius medialis
Model.Lts(33,1) = 0.38500000 * scaleRatio;    % Gastrocnemius lateralis
Model.Lts(34,1) = 0.26800000 * scaleRatio;    % Soleus
Model.Lts(35,1) = 0.31000000 * scaleRatio;    % Tibialis posterior
Model.Lts(36,1) = 0.22300000 * scaleRatio;    % Tibialis anterior
Model.Lts(37,1) = 0.16100000 * scaleRatio;    % Peroneus brevis
Model.Lts(38,1) = 0.34500000 * scaleRatio;    % Peroneus longus
Model.Lts(39,1) = 0.10000000 * scaleRatio;    % Peroneus tertius
Model.Lts(40,1) = 0.34500000 * scaleRatio;    % Extensor digitorum longus
Model.Lts(41,1) = 0.30500000 * scaleRatio;    % Extensor hallucis longus
Model.Lts(42,1) = 0.40000000 * scaleRatio;    % Flexor digitorum longus
Model.Lts(43,1) = 0.38000000 * scaleRatio;    % Flexor hallucis longus

% -------------------------------------------------------------------------
% Pennation angle at optimal isometric length (radian) (Delp 1990)
% -------------------------------------------------------------------------
Model.pennation(1,1) = 0.08726646;           % Gluteus maximus I
Model.pennation(2,1) = 0.00000000;           % Gluteus maximus II
Model.pennation(3,1) = 0.08726646;           % Gluteus maximus III
Model.pennation(4,1) = 0.13962634;           % Gluteus medius I
Model.pennation(5,1) = 0.00000000;           % Gluteus medius II
Model.pennation(6,1) = 0.33161256;           % Gluteus medius III
Model.pennation(7,1) = 0.17453293;           % Gluteus minimus I
Model.pennation(8,1) = 0.00000000;           % Gluteus minimus II
Model.pennation(9,1) = 0.36651914;           % Gluteus minimus III
Model.pennation(10,1) = 0.10471976;          % Adductor longus
Model.pennation(11,1) = 0.00000000;          % Adductor brevis
Model.pennation(12,1) = 0.08726646;          % Adductor magnus I
Model.pennation(13,1) = 0.05235988;          % Adductor magnus II
Model.pennation(14,1) = 0.08726646;          % Adductor magnus III
Model.pennation(15,1) = 0.00000000;          % Pectineus
Model.pennation(16,1) = 0.12217305;          % Iliacus
Model.pennation(17,1) = 0.13962634;          % Psoas
Model.pennation(18,1) = 0.00000000;          % Quadratus femoris
Model.pennation(19,1) = 0.00000000;          % Gemelli
Model.pennation(20,1) = 0.17453293;          % Piriformis
Model.pennation(21,1) = 0.05235988;          % Tensor fascia lata
Model.pennation(22,1) = 0.05235988;          % Gracilis 
Model.pennation(23,1) = 0.00000000;          % Sartorius
Model.pennation(24,1) = 0.26179939;          % Semimembranosus
Model.pennation(25,1) = 0.08726646;          % Semitendinosus
Model.pennation(26,1) = 0.00000000;          % Biceps femoris long head
Model.pennation(27,1) = 0.40142573;          % Biceps femoris short head
Model.pennation(28,1) = 0.08726646;          % Rectus femoris
Model.pennation(29,1) = 0.08726646;          % Vastus medialis
Model.pennation(30,1) = 0.05235988;          % Vastus intermedius
Model.pennation(31,1) = 0.08726646;          % Vastus lateralis
Model.pennation(32,1) = 0.29670597;          % Gastrocnemius medialis
Model.pennation(33,1) = 0.13962634;          % Gastrocnemius lateralis
Model.pennation(34,1) = 0.43633231;          % Soleus
Model.pennation(35,1) = 0.20943951;          % Tibialis posterior
Model.pennation(36,1) = 0.08726646;          % Tibialis anterior
Model.pennation(37,1) = 0.08726646;          % Peroneus brevis
Model.pennation(38,1) = 0.17453293;          % Peroneus longus
Model.pennation(39,1) = 0.22689280;          % Peroneus tertius
Model.pennation(40,1) = 0.13962634;          % Extensor digitorum longus
Model.pennation(41,1) = 0.10471976;          % Extensor hallucis longus
Model.pennation(42,1) = 0.12217305;          % Flexor digitorum longus
Model.pennation(43,1) = 0.17453293;          % Flexor hallucis longus

% -------------------------------------------------------------------------
% PCSA (Thorpe 1997 + Friedrich and Brand 1990)
% -------------------------------------------------------------------------
Model.PCSA(1,1) = 41.7/3;        % Gluteus maximus I
Model.PCSA(2,1) = 41.7/3;        % Gluteus maximus II
Model.PCSA(3,1) = 41.7/3;        % Gluteus maximus III
Model.PCSA(4,1) = 21.60;         % Gluteus medius I
Model.PCSA(5,1) = 15.70;         % Gluteus medius II
Model.PCSA(6,1) = 16.80;         % Gluteus medius III
Model.PCSA(7,1) = 9.60;          % Gluteus minimus I
Model.PCSA(8,1) = 10.00;         % Gluteus minimus II
Model.PCSA(9,1) = 11.00;         % Gluteus minimus III
Model.PCSA(10,1) = 15.00;        % Adductor longus
Model.PCSA(11,1) = 9.70;         % Adductor brevis
Model.PCSA(12,1) = (22+25)/3;    % Adductor magnus I
Model.PCSA(13,1) = (22+25)/3;    % Adductor magnus II
Model.PCSA(14,1) = (22+25)/3;    % Adductor magnus III
Model.PCSA(15,1) = 5.40;         % Pectineus
Model.PCSA(16,1) = 32.00;        % Illiacus
Model.PCSA(17,1) = 15.6;         % Psoas
Model.PCSA(18,1) = 21.00;        % Quadratus femoris
Model.PCSA(19,1) = 4.33;         % Gemelli
Model.PCSA(20,1) = 20.54;        % Piriformis
Model.PCSA(21,1) = 5.20;         % Tensor fasciae latae
Model.PCSA(22,1) = 3.40;         % Gracilis 
Model.PCSA(23,1) = 3.65;         % Sartorius
Model.PCSA(24,1) = 39.90;        % Semimembranosus
Model.PCSA(25,1) = 9.40;         % Semitendinosus
Model.PCSA(26,1) = 28.80;        % Biceps femoris long head
Model.PCSA(27,1) = 8.14;         % Biceps femoris short head
Model.PCSA(28,1) = 33.60;        % Rectus femoris
Model.PCSA(29,1) = 46.70;        % Vastus medialis
Model.PCSA(30,1) = 53.70;        % Vastus intermedius
Model.PCSA(31,1) = 68.80;        % Vastus lateralis
Model.PCSA(32,1) = 41.80;        % Gastrocnemius medialis
Model.PCSA(33,1) = 19.90;        % Gastrocnemius lateralis
Model.PCSA(34,1) = 118.70;       % Soleus
Model.PCSA(35,1) = 36.20;        % Tibialis posterior
Model.PCSA(36,1) = 20.40;        % Tibialis anterior
Model.PCSA(37,1) = 11.50;        % Peroneus brevis
Model.PCSA(38,1) = 21.40;        % Peroneus longus
Model.PCSA(39,1) = 4.14;         % Peroneus tertius
Model.PCSA(40,1) = 10.50;        % Extensor digitorum longus
Model.PCSA(41,1) = 4.85;         % Extensor hallucis longus
Model.PCSA(42,1) = 9.90;         % Flexor digitorum longus
Model.PCSA(43,1) = 14.10;        % Flexor hallucis longus

% -------------------------------------------------------------------------
% Force max (Delp 1990 = Wickiewicz 1983 & Brand 1986)
% -------------------------------------------------------------------------
Model.Fmax(1,1) = 382;           % Gluteus maximus I
Model.Fmax(2,1) = 546;           % Gluteus maximus II
Model.Fmax(3,1) = 368;           % Gluteus maximus III
Model.Fmax(4,1) = 546;           % Gluteus medius I
Model.Fmax(5,1) = 383;           % Gluteus medius II
Model.Fmax(6,1) = 435;           % Gluteus medius III
Model.Fmax(7,1) = 180;           % Gluteus minimus I
Model.Fmax(8,1) = 190;           % Gluteus minimus II
Model.Fmax(9,1) = 215;           % Gluteus minimus III
Model.Fmax(10,1) = 418;          % Adductor longus
Model.Fmax(11,1) = 286;          % Adductor brevis
Model.Fmax(12,1) = 346;          % Adductor magnus I
Model.Fmax(13,1) = 312;          % Adductor magnus II
Model.Fmax(14,1) = 444;          % Adductor magnus III
Model.Fmax(15,1) = 177;          % Pectineus
Model.Fmax(16,1) = 429;          % Iliacus
Model.Fmax(17,1) = 371;          % Psoas
Model.Fmax(18,1) = 254;          % Quadratus femoris
Model.Fmax(19,1) = 109;          % Gemelli
Model.Fmax(20,1) = 296;          % Piriformis
Model.Fmax(21,1) = 155;          % Tensor fascia lata
Model.Fmax(22,1) = 108;          % Gracilis 
Model.Fmax(23,1) = 104;          % Sartorius
Model.Fmax(24,1) = 1030;         % Semimembranosus
Model.Fmax(25,1) = 328;          % Semitendinosus
Model.Fmax(26,1) = 717;          % Biceps femoris long head
Model.Fmax(27,1) = 402;          % Biceps femoris short head
Model.Fmax(28,1) = 779;          % Rectus femoris
Model.Fmax(29,1) = 1294;         % Vastus medialis
Model.Fmax(30,1) = 1365;         % Vastus intermedius
Model.Fmax(31,1) = 1871;         % Vastus lateralis
Model.Fmax(32,1) = 1113;         % Gastrocnemius medialis
Model.Fmax(33,1) = 488;          % Gastrocnemius lateralis
Model.Fmax(34,1) = 2839;         % Soleus
Model.Fmax(35,1) = 1270;         % Tibialis posterior
Model.Fmax(36,1) = 603;          % Tibialis anterior
Model.Fmax(37,1) = 348;          % Peroneus brevis
Model.Fmax(38,1) = 754;          % Peroneus longus
Model.Fmax(39,1) = 90;           % Peroneus tertius
Model.Fmax(40,1) = 341;          % Extensor digitorum longus
Model.Fmax(41,1) = 108;          % Extensor hallucis longus
Model.Fmax(42,1) = 310;          % Flexor digitorum longus
Model.Fmax(43,1) = 322;          % Flexor hallucis longus
Model.Fmax(43+1,1) = weight*9.81*3.5;  % Ankle contact about Y axis (following Pandy and Andriacchi 2010)
Model.Fmax(43+2,1) = weight*9.81*0.5;  % TiCaL (following Moissenet at al. 2012)
Model.Fmax(43+3,1) = weight*9.81*0.2;  % CaFiL (following Moissenet at al. 2012)
Model.Fmax(43+4,1) = weight*9.81*1.8;  % Knee medial contact (following Lin et al. 2010)
Model.Fmax(43+5,1) = weight*9.81*1.0;  % Knee lateral contact (following Lin et al. 2010)
Model.Fmax(43+6,1) = weight*9.81*0.9;  % ACL (following Hu et al. 2013 / Moissenet at al. 2012)
Model.Fmax(43+7,1) = weight*9.81*0.9;  % PCL (following Hu et al. 2013 / Moissenet at al. 2012)
Model.Fmax(43+8,1) = weight*9.81*3.0;  % Patellar contact about X axis (following Trepczynski et al. 2012)
Model.Fmax(43+9,1) = weight*9.81*1.0;  % PT (following Trepczynski et al. 2012)
Model.Fmax(43+10,1) = weight*9.81*2.4; % Hip contact about Y axis (following Bergmann et al. 2001)
Model.Fmax(43+11,1) = weight*9.81*3.7; % Tibia axial (following Wehner et al. 2009)
Model.Fmax(43+12,1) = weight*9.81*3.5; % Femur axial (following Lu et al. 1997 / Taylor et al. 1998)

% % -------------------------------------------------------------------------
% % Corrected force max (Arnold 2010)
% % -------------------------------------------------------------------------
% for i = 1:43
%     Model.Fmax(i) = Model.PCSA(i)*61; % 61 N/cm^2
% end

% -------------------------------------------------------------------------
% Virtual markers
% Coordinates in (ui, rPi-rDi, wi)
% -------------------------------------------------------------------------
% Foot (i = 2)
% Scaled by the shank length
% Virtual markers start at 4 (others are for ankle joint)
% + [0; -0.01; 0] : corrective translation for position of talus center
% + [-0.04877; -0.04195; 0.00792] : position of the calcaneus in the talus coordinate system
% + [0.1788; -0.002; 0.00108] : position of the toes in the calcaneus coordinate system
Segment(2).nV(:,4)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of gastrocnemius medialis
    (Segment(3).L/Lm(3));
Segment(2).nV(:,5)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of gastrocnemius lateralis
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,6)  = inv(Segment(2).B) * ...
    ([0.00440000; 0.03100000; -0.00530000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of soleus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,7)  = inv(Segment(2).B) * ...
    ([0.04170000; 0.03340000; -0.02860000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 2 of tibialis posterior
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,8)  = inv(Segment(2).B) * ...
    ([0.04170000; 0.03340000; -0.02860000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of tibialis posterior
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,9)  = inv(Segment(2).B) * ...
    ([0.07720000; 0.01590000; -0.02810000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of tibialis posterior
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,10)  = inv(Segment(2).B) * ... 
    ([0.11660000; 0.01780000; -0.03050000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of tibialis anterior
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,11)  = inv(Segment(2).B) * ... 
    ([0.04710000; 0.02700000; 0.02330000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 4 of peroneus brevis
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,12)  = inv(Segment(2).B) * ... 
    ([0.06770000; 0.02190000; 0.03430000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of peroneus brevis
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,13) = inv(Segment(2).B) * ... 
    ([0.04380000; 0.02300000; 0.02210000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of peroneus longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,14) = inv(Segment(2).B) * ... 
    ([0.06810000; 0.01060000; 0.02840000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 4 of peroneus longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,15) = inv(Segment(2).B) * ... 
    ([0.08520000; 0.00690000; 0.01180000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 5 of peroneus longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,16) = inv(Segment(2).B) * ... 
    ([0.12030000; 0.00850000; -0.01840000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of peroneus longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,17) = inv(Segment(2).B) * ... 
    ([0.08570000; 0.02280000; 0.02990000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Insertion of peroneus tertius
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,18) = inv(Segment(2).B) * ... 
    ([0.09220000; 0.03880000; -0.00010000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 2 of extensor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,19) = inv(Segment(2).B) * ... 
    ([0.16160000; 0.00550000; 0.01300000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of extensor digitorum longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,20) = inv(Segment(2).B) * ... 
    ([0.00030000; 0.00470000; 0.01530000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Via point 4 of extensor digitorum longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,21) = inv(Segment(2).B) * ... 
    ([0.04430000; -0.00040000; 0.02500000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Insertion of extensor digitorum longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,22) = inv(Segment(2).B) * ...
    ([0.09700000; 0.03890000; -0.02110000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 2 of extensor hallucis longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,23) = inv(Segment(2).B) * ...
    ([0.12930000; 0.03090000; -0.02570000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of extensor hallucis longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,24) = inv(Segment(2).B) * ...
    ([0.17340000; 0.01390000; -0.02800000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 4 of extensor hallucis longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,25) = inv(Segment(2).B) * ...
    ([0.02980000; 0.00410000; -0.02450000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Via point 5 of extensor hallucis longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,26) = inv(Segment(2).B) * ...
    ([0.05630000; 0.00340000; -0.01860000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Insertion of extensor hallucis longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,27) = inv(Segment(2).B) * ...
    ([0.04360000; 0.03150000; -0.02800000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 2 of flexor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,28) = inv(Segment(2).B) * ...
    ([0.07080000; 0.01760000; -0.02630000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of flexor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,29) = inv(Segment(2).B) * ...
    ([0.16580000; -0.00810000; 0.01160000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 4 of flexor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,30) = inv(Segment(2).B) * ...
    ([-0.00190000; -0.00780000; 0.01470000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Via point 5 of flexor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,31) = inv(Segment(2).B) * ...
    ([0.02850000; -0.00710000; 0.02150000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Via point 6 of flexor digitorum longus
    (Segment(3).L/Lm(3)); 
Segment(2).nV(:,32) = inv(Segment(2).B) * ...
    ([0.04410000; -0.00600000; 0.02420000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Insertion of flexor digitorum longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,33) = inv(Segment(2).B) * ...
    ([0.03740000; 0.02760000; -0.02410000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 2 of flexor hallucis longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,34) = inv(Segment(2).B) * ...
    ([0.10380000; 0.00680000; -0.02560000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 3 of flexor hallucis longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,35) = inv(Segment(2).B) * ...
    ([0.17260000; -0.00530000; -0.02690000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792]) * ... % Via point 4 of flexor hallucis longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,36) = inv(Segment(2).B) * ...
    ([0.01550000; -0.00640000; -0.02650000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Via point 5 of flexor hallucis longus
    (Segment(3).L/Lm(3));
Segment(2).nV(:,37) = inv(Segment(2).B) * ...
    ([0.05620000; -0.01020000; -0.01810000] + [0; -0.01; 0] + [-0.04877; -0.04195; 0.00792] + [0.1788; -0.002; 0.00108]) * ... % Insertion of flexor hallucis longus
    (Segment(3).L/Lm(3));

% Shank (i = 3)
% Virtual markers start at 10 (others are for ankle, tibio-femoral and patello-femoral joints)
Segment(3).nV(:,10) = inv(Segment(3).B) * ...
    [0.00600000; -0.04870000; 0.02970000] * ... % Insertion of tensor fascia lata
    (Segment(3).L/Lm(3));
Segment(3).nV(:,11) = inv(Segment(3).B) * ...
    [-0.01540000; -0.04750000; -0.03580000] * ... % Via point 1 of gracillis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,12) = inv(Segment(3).B) * ...
    [0.00600000; -0.08360000; -0.02280000] * ... % Insertion of gracillis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,13) = inv(Segment(3).B) * ...
    [-0.02430000; -0.05360000; -0.01940000] * ... % Insertion of semimembranosus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,14) = inv(Segment(3).B) * ...
    [-0.03140000; -0.05450000; -0.01460000] * ... % Via point 1 of semitendinus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,15) = inv(Segment(3).B) * ...
    [-0.01130000; -0.07460000; -0.02450000] * ... % Via point 2 of semitendinus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,16) = inv(Segment(3).B) * ...
    [0.00270000; -0.09560000; -0.01930000] * ... % Insertion of semitendinus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,17) = inv(Segment(3).B) * ...
    [-0.00810000; -0.07290000; 0.04230000] * ... % Insertion of biceps femoris long head
    (Segment(3).L/Lm(3));
Segment(3).nV(:,18) = inv(Segment(3).B) * ...
    [-0.00560000; -0.04190000; -0.03990000] * ... % Via point 2 of sartorius
    (Segment(3).L/Lm(3));
Segment(3).nV(:,19) = inv(Segment(3).B) * ...
    [0.00600000; -0.05890000; -0.03830000] * ... % Via point 3 of sartorius
    (Segment(3).L/Lm(3));
Segment(3).nV(:,20) = inv(Segment(3).B) * ...
    [0.02430000; -0.08400000; -0.02520000] * ... % Insertion of sartorius
    (Segment(3).L/Lm(3));
Segment(3).nV(:,21) = inv(Segment(3).B) * ...
    [-0.01010000; -0.07250000; 0.04060000] * ... % Insertion of biceps femoris short head
    (Segment(3).L/Lm(3));
Segment(3).nV(:,22) = inv(Segment(3).B) * ...
    [-0.02170000; -0.04870000; -0.02950000] * ... % Via point 2 of gastrocnemius medialis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,23) = inv(Segment(3).B) * ...
    [-0.02420000; -0.04810000; 0.02350000] * ... % Via point 2 of gastrocnemius lateralis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,24) = inv(Segment(3).B) * ...
    [-0.00240000; -0.15330000; 0.00710000] * ... % Origin of soleus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,25) = inv(Segment(3).B) * ...
    [-0.00940000; -0.13480000; 0.00190000] * ... % Origin of tibialis posterior
    (Segment(3).L/Lm(3));
Segment(3).nV(:,26) = inv(Segment(3).B) * ...
    [-0.01440000; -0.40510000; -0.02290000] * ... % Via point 1 of tibialis posterior
    (Segment(3).L/Lm(3));
Segment(3).nV(:,27) = inv(Segment(3).B) * ...
    [0.01790000; -0.16240000; 0.01150000] * ... % Origin of tibialis anterior
    (Segment(3).L/Lm(3));
Segment(3).nV(:,28) = inv(Segment(3).B) * ...
    [0.03290000; -0.39510000; -0.01770000] * ... % Via point 1 of tibialis anterior
    (Segment(3).L/Lm(3));
Segment(3).nV(:,29) = inv(Segment(3).B) * ...
    [-0.00700000; -0.26460000; 0.03250000] * ... % Origin of peroneus brevis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,30) = inv(Segment(3).B) * ...
    [-0.01980000; -0.41840000; 0.02830000] * ... % Via point 1 of peroneus brevis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,31) = inv(Segment(3).B) * ...
    [-0.01440000; -0.42950000; 0.02890000] * ... % Via point 2 of peroneus brevis
    (Segment(3).L/Lm(3));
Segment(3).nV(:,32) = inv(Segment(3).B) * ...
    [0.00050000; -0.15680000; 0.03620000] * ... % Origin of peroneus longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,33) = inv(Segment(3).B) * ...
    [-0.02070000; -0.42050000; 0.02860000] * ... % Via point 1 of peroneus longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,34) = inv(Segment(3).B) * ...
    [-0.01620000; -0.43190000; 0.02890000] * ... % Via point 2 of peroneus longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,35) = inv(Segment(3).B) * ...
    [0.00100000; -0.28040000; 0.02310000] * ... % Origin of peroneus tertius
    (Segment(3).L/Lm(3));
Segment(3).nV(:,36) = inv(Segment(3).B) * ...
    [0.02290000; -0.40690000; 0.01590000] * ... % Via point 1 of peroneus tertius
    (Segment(3).L/Lm(3));
Segment(3).nV(:,37) = inv(Segment(3).B) * ...
    [0.00320000; -0.13810000; 0.02760000] * ... % Origin of extensor digitorum longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,38) = inv(Segment(3).B) * ...
    [0.02890000; -0.40070000; 0.00720000] * ... % Via point 1 of extensor digitorum longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,39) = inv(Segment(3).B) * ...
    [0.00120000; -0.17670000; 0.02280000] * ... % Origin of extensor hallucis longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,40) = inv(Segment(3).B) * ...
    [0.03260000; -0.39850000; -0.00850000] * ... % Via point 1 of extensor hallucis longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,41) = inv(Segment(3).B) * ...
    [-0.00830000; -0.20460000; -0.00180000] * ... % Origin of flexor digitorum longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,42) = inv(Segment(3).B) * ...
    [-0.01540000; -0.40510000; -0.01960000] * ... % Via point 1 of flexor digitorum longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,43) = inv(Segment(3).B) * ...
    [-0.00790000; -0.23340000; 0.02440000] * ... % Origin of flexor hallucis longus
    (Segment(3).L/Lm(3));
Segment(3).nV(:,44) = inv(Segment(3).B) * ...
    [-0.01860000; -0.40790000; -0.01740000] * ... % Via point 1 of flexor hallucis longus
    (Segment(3).L/Lm(3));

% Patella (i = 4)
% Scaled by thigh length
% Virtual markers start at 2 (other is for patello-femoral joint)
Segment(4).nV(:,2) = [0;-1;0] + inv(Segment(4).B) * ...
    ([0.01210000; 0.04370000; -0.00100000]) * ... % Insertion of rectus femoris
    (Segment(5).L/Lm(5)); 
Segment(4).nV(:,3) = [0;-1;0] + inv(Segment(4).B) * ...
    ([0.00630000; 0.04450000; -0.01700000]) * ... % Insertion of vastus medialis
    (Segment(5).L/Lm(5)); 
Segment(4).nV(:,4) = [0;-1;0] + inv(Segment(4).B) * ...
    ([0.00580000; 0.04800000; -0.00060000]) * ... % Insertion of vastus intermedialis
    (Segment(5).L/Lm(5)); 
Segment(4).nV(:,5) = [0;-1;0] + inv(Segment(4).B) * ...
    ([0.01030000; 0.04230000; 0.01410000]) * ... % Insertion of vastus lateralis
    (Segment(5).L/Lm(5)); 

% Thigh (i = 5)
% Virtual markers start at 7 (others are for tibio-femoral joint)
Segment(5).nV(:,7)  = inv(Segment(5).B) * ...
    [-0.04570000; -0.02480000; 0.03920000] * ... % Via point 2 of gluteus maximus I
    (Segment(5).L/Lm(5));
Segment(5).nV(:,8)  = inv(Segment(5).B) * ...
    [-0.02770000; -0.05660000; 0.04700000] * ... % Insertion of gluteus maximus I
    (Segment(5).L/Lm(5));  
Segment(5).nV(:,9)  = inv(Segment(5).B) * ...
    [-0.04260000; -0.05300000; 0.02930000] * ... % Via point 2 of gluteus maximus II
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,10)  = inv(Segment(5).B) * ...
    [-0.01560000; -0.10160000; 0.04190000] * ... % Insertion of gluteus maximus II
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,11)  = inv(Segment(5).B) * ...
    [-0.02990000; -0.10410000; 0.01350000] * ... % Via point 2 of gluteus maximus III
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,12)  = inv(Segment(5).B) * ...
    [-0.00600000; -0.14190000; 0.04110000] * ... % Insertion of gluteus maximus III
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,13) = inv(Segment(5).B) * ...
    [-0.02180000; -0.01170000; 0.05550000] * ... % Insertion of gluteus medius I
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,14) = inv(Segment(5).B) * ...
    [-0.02580000; -0.00580000; 0.05270000] * ... % Insertion of gluteus medius II
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,15) = inv(Segment(5).B) * ...
    [-0.03090000; -0.00470000; 0.05180000] * ... % Insertion of gluteus medius III
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,16) = inv(Segment(5).B) * ...
    [-0.00720000; -0.01040000; 0.05600000] * ... % Insertion of gluteus minimus I
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,17) = inv(Segment(5).B) * ...
    [-0.00960000; -0.01040000; 0.05600000] * ... % Insertion of gluteus minimus II
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,18) = inv(Segment(5).B) * ...
    [-0.01350000; -0.00830000; 0.05500000] * ... % Insertion of gluteus minimus III
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,19) = inv(Segment(5).B) * ...
    [0.00500000; -0.21110000; 0.02340000] * ... % Insertion of adductor longus
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,20) = inv(Segment(5).B) * ...
    [0.00090000; -0.11960000; 0.02940000] * ... % Insertion of adductor brevis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,21) = inv(Segment(5).B) * ...
    [-0.00450000; -0.12110000; 0.03390000] * ... % Insertion of adductor magnus I
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,22) = inv(Segment(5).B) * ...
    [0.00540000; -0.22850000; 0.02270000] * ... % Insertion of adductor magnus II
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,23) = inv(Segment(5).B) * ...
    [0.00700000; -0.38370000; -0.02660000] * ...  % Insertion of adductor magnus III
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,24) = inv(Segment(5).B) * ...
    [-0.01220000; -0.08220000; 0.02530000] * ... % Insertion of pectineus
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,25) = inv(Segment(5).B) * ...
    [0.00170000; -0.05430000; 0.00570000] * ... % Via point 2 of iliacus
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,26) = inv(Segment(5).B) * ...
    [-0.01930000; -0.06210000; 0.01290000] * ... % Insertion of iliacus
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,27) = inv(Segment(5).B) * ...
    [0.00160000; -0.05070000; 0.00380000] * ... % Via point 2 of psoas
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,28) = inv(Segment(5).B) * ...
    [-0.01880000; -0.05970000; 0.01040000] * ... % Insertion of psoas
    (Segment(5).L/Lm(5));
Segment(5).nV(:,29) = inv(Segment(5).B) * ...
    [-0.03810000; -0.03590000; 0.03660000] * ... % Insertion of quadratus femoris
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,30) = inv(Segment(5).B) * ...
    [-0.01420000; -0.00330000; 0.04430000] * ... % Insertion of gemellus
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,31) = inv(Segment(5).B) * ...
    [-0.01480000; -0.00360000; 0.04370000] * ... % Insertion of piriformis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,32) = inv(Segment(5).B) * ...
    [0.02940000; -0.09950000; 0.05970000] * ... % Via point 1 tensor fascia lata
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,33) = inv(Segment(5).B) * ...
    [0.00540000; -0.40490000; 0.03570000] * ... % Via point 2 tensor fascia lata
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,34) = inv(Segment(5).B) * ...
    [-0.00300000; -0.35680000; -0.04210000] * ... % Via point of sartorius
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,35) = inv(Segment(5).B) * ... 
    [0.00500000; -0.21110000; 0.02340000] * ... % Origin of biceps femoris short head
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,36) = inv(Segment(5).B) * ...
    [0.03340000; -0.40300000; 0.00190000] * ... % Via point 1 of rectus femoris (from -83.65 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,37) = inv(Segment(5).B) * ...
    [0.01400000; -0.20990000; 0.01880000] * ... % Origin of vastus medialis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,38) = inv(Segment(5).B) * ...
    [0.03560000; -0.27690000; 0.00090000] * ... % Via point 1 of vastus medialis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,39) = inv(Segment(5).B) * ...
    [0.03700000; -0.40480000; -0.01250000] * ... % Via point 2 of vastus medialis (from -69.36 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,40) = inv(Segment(5).B) * ...
    [0.02740000; -0.42550000; -0.01310000] * ... % Via point 3 of vastus medialis (from -102 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,41) = inv(Segment(5).B) * ...
    [0.02900000; -0.19240000; 0.03100000] * ... % Origin of vastus intermedialis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,42) = inv(Segment(5).B) * ...
    [0.03350000; -0.20840000; 0.02850000] * ... % Via point 1 of vastus intermedialis
    (Segment(5).L/Lm(5));
Segment(5).nV(:,43) = inv(Segment(5).B) * ...
    [0.03430000; -0.40300000; 0.00550000] * ... % Via point 2 of vastus intermedialis (from -81.40 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5));
Segment(5).nV(:,44) = inv(Segment(5).B) * ...
    [0.00480000; -0.18540000; 0.03490000] * ... % Origin of vastus lateralis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,45) = inv(Segment(5).B) * ...
    [0.02690000; -0.25910000; 0.04090000] * ... % Via point 1 of vastus lateralis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,46) = inv(Segment(5).B) * ...
    [0.03610000; -0.40300000; 0.02050000] * ... % Via point 2 of vastus lateralis (from -69.36 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5));
Segment(5).nV(:,47) = inv(Segment(5).B) * ...
    [0.02530000; -0.42430000; 0.01840000] * ... % Via point 3 of vastus lateralis (from -110.06 to -150 degrees of knee flexion)
    (Segment(5).L/Lm(5));
Segment(5).nV(:,48) = inv(Segment(5).B) * ...
    [-0.01270000; -0.39290000; -0.02350000] * ... % Origin of gastrocnemius medialis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,49) = inv(Segment(5).B) * ...
    [-0.02390000; -0.40220000; -0.02580000] * ... % Via point 1 of gastrocnemius medialis (from -44.14 to 5.73 degrees of knee flexion)
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,50) = inv(Segment(5).B) * ...
    [-0.01550000; -0.39460000; 0.02720000] * ... % Origin of gastrocnemius lateralis
    (Segment(5).L/Lm(5)); 
Segment(5).nV(:,51) = inv(Segment(5).B) * ...
    [-0.02540000; -0.40180000; 0.02740000] * ... % Via point 1 of gastrocnemius lateralis (from -44.14 to 5.73 degrees of knee flexion)
    (Segment(5).L/Lm(5)); 

% Pelvis (i = 6)
% Virtual markers start at 2 (other is for hip joint)
% + [0.0707; 0.0661; -0.0835] : corrective translation for position of pelvis center
Segment(6).nV(:,2)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.11950000; 0.06120000; 0.07000000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus maximus I
    (Segment(6).L/Lm(6));
Segment(6).nV(:,3)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.12910000; 0.00120000; 0.08860000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of gluteus maximus I
    (Segment(6).L/Lm(6));
Segment(6).nV(:,4)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.13490000; 0.01760000; 0.05630000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus maximus II
    (Segment(6).L/Lm(6));
Segment(6).nV(:,5)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.13760000; -0.05200000; 0.09140000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of gluteus maximus II
    (Segment(6).L/Lm(6));
Segment(6).nV(:,6)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.15560000; -0.03140000; 0.00580000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus maximus III
    (Segment(6).L/Lm(6));
Segment(6).nV(:,7)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.15290000; -0.10520000; 0.04030000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of gluteus maximus III
    (Segment(6).L/Lm(6));
Segment(6).nV(:,8)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.04080000; 0.03040000; 0.12090000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus medius I
    (Segment(6).L/Lm(6));
Segment(6).nV(:,9)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.08550000; 0.04450000; 0.07660000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus medius II
    (Segment(6).L/Lm(6));
Segment(6).nV(:,10)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.12230000; 0.01050000; 0.06480000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus medius III
    (Segment(6).L/Lm(6));
Segment(6).nV(:,11)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.04670000; -0.00800000; 0.10560000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus minimus I
    (Segment(6).L/Lm(6));
Segment(6).nV(:,12)  = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.06330000; -0.00650000; 0.09910000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus minimus II
    (Segment(6).L/Lm(6));
Segment(6).nV(:,13) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.08340000; -0.00630000; 0.08560000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gluteus minimus III
    (Segment(6).L/Lm(6));
Segment(6).nV(:,14) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.03160000; -0.08360000; 0.01690000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of adductor longus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,15) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.05870000; -0.09150000; 0.01640000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of adductor brevis
    (Segment(6).L/Lm(6));
Segment(6).nV(:,16) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.07320000; -0.11740000; 0.02550000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of adductor magnus I
    (Segment(6).L/Lm(6));
Segment(6).nV(:,17) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.08310000; -0.11920000; 0.03080000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of adductor magnus II
    (Segment(6).L/Lm(6));
Segment(6).nV(:,18) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.07710000; -0.11810000; 0.02760000] + [0.0707; 0.0661; -0.0835]) *... % Origin of adductor magnus III
    (Segment(6).L/Lm(6));
Segment(6).nV(:,19) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.04310000; -0.07680000; 0.04510000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of pectineus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,20) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.06740000; 0.03650000; 0.08540000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of iliacus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,21) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.02180000; -0.05500000; 0.08510000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of iliacus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,22) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.06470000; 0.08870000; 0.02890000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of psoas
    (Segment(6).L/Lm(6));
Segment(6).nV(:,23) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.02380000; -0.05700000; 0.07590000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of psoas
    (Segment(6).L/Lm(6));
Segment(6).nV(:,24) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.11430000; -0.11510000; 0.05200000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of quadratus femoris
    (Segment(6).L/Lm(6));
Segment(6).nV(:,25) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.11330000; -0.08200000; 0.07140000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gemellus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,26) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.13960000; 0.00030000; 0.02350000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of piriformis
    (Segment(6).L/Lm(6));
Segment(6).nV(:,27) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.11930000; -0.02760000; 0.06570000] + [0.0707; 0.0661; -0.0835]) * ... % Via point 1 of piriformis
    (Segment(6).L/Lm(6));
Segment(6).nV(:,28) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.03110000; 0.02140000; 0.12410000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of tensor fascia lata
    (Segment(6).L/Lm(6));
Segment(6).nV(:,29) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.05630000; -0.10380000; 0.00790000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of gracilis
    (Segment(6).L/Lm(6));
Segment(6).nV(:,30) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.11920000; -0.10150000; 0.06950000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of semimembranosus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,31) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.12370000; -0.10430000; 0.06030000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of semitendinus
    (Segment(6).L/Lm(6));
Segment(6).nV(:,32) = Segment(6).nV(:,1) + inv(Segment(6).B) * ....
    ([-0.12440000; -0.10010000; 0.06660000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of biceps femoris long head
    (Segment(6).L/Lm(6));
Segment(6).nV(:,33) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.01530000; -0.00130000; 0.12420000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of sartorius
    (Segment(6).L/Lm(6));
Segment(6).nV(:,34) = Segment(6).nV(:,1) + inv(Segment(6).B) * ...
    ([-0.02950000; -0.03110000; 0.09680000] + [0.0707; 0.0661; -0.0835]) * ... % Origin of rectus femoris
    (Segment(6).L/Lm(6));

% -------------------------------------------------------------------------
% Interpolation matrices
% -------------------------------------------------------------------------
% Foot (i = 2)
for i = 4:37
	eval(['NV',num2str(i),'2',' = [Segment(2).nV(1,',num2str(i),')*eye(3),(1 + Segment(2).nV(2,',num2str(i),'))*eye(3), - Segment(2).nV(2,',num2str(i),')*eye(3), Segment(2).nV(3,',num2str(i),')*eye(3)];']);
end

% Shank (i = 3)
for i = 10:44
	eval(['NV',num2str(i),'3',' = [Segment(3).nV(1,',num2str(i),')*eye(3),(1 + Segment(3).nV(2,',num2str(i),'))*eye(3), - Segment(3).nV(2,',num2str(i),')*eye(3), Segment(3).nV(3,',num2str(i),')*eye(3)];']);
end

% Patella (i = 4)
for i = 2:5
	eval(['NV',num2str(i),'4',' = [Segment(4).nV(1,',num2str(i),')*eye(3),(1 + Segment(4).nV(2,',num2str(i),'))*eye(3), - Segment(4).nV(2,',num2str(i),')*eye(3), Segment(4).nV(3,',num2str(i),')*eye(3)];']);
end

% Thigh (i = 5)
for i = 7:51
	eval(['NV',num2str(i),'5',' = [Segment(5).nV(1,',num2str(i),')*eye(3),(1 + Segment(5).nV(2,',num2str(i),'))*eye(3), - Segment(5).nV(2,',num2str(i),')*eye(3), Segment(5).nV(3,',num2str(i),')*eye(3)];']);
end

% Pelvis (i = 6)
for i = 2:34
	eval(['NV',num2str(i),'6',' = [Segment(6).nV(1,',num2str(i),')*eye(3),(1 + Segment(6).nV(2,',num2str(i),'))*eye(3), - Segment(6).nV(2,',num2str(i),')*eye(3), Segment(6).nV(3,',num2str(i),')*eye(3)];']);
end

% -------------------------------------------------------------------------
% Knee flexion angle
% -------------------------------------------------------------------------
Joint(3).T = Mprod_array3(Tinv_array3(Q2Twu_array3(Segment(5).Q)), ...
    Q2Tuv_array3(Segment(3).Q));
Joint(3).Euler = R2mobileZYX_array3(Joint(3).T(1:3,1:3,:));
FE3 = permute(Joint(3).Euler(1,1,:),[3,2,1])*180/pi;     

% -------------------------------------------------------------------------
% Generalised lever arms
% -------------------------------------------------------------------------
% Initialisation
Model.Lever = zeros(48,43,n);

% Gluteus maximus I
Model.Lever(:,1,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV75',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV36,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV75,[1,1,n]),Segment(5).Q)))];

% Gluteus maximus II
Model.Lever(:,2,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV95',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV56,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV95,[1,1,n]),Segment(5).Q)))];

% Gluteus maximus III
Model.Lever(:,3,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV115',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV76,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV115,[1,1,n]),Segment(5).Q)))];

% Gluteus medius I
Model.Lever(:,4,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV135',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV86,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV135,[1,1,n]),Segment(5).Q)))];

% Gluteus medius II
Model.Lever(:,5,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV145',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV96,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV145,[1,1,n]),Segment(5).Q)))];

% Gluteus medius III
Model.Lever(:,6,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV155',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV106,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV155,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus I
Model.Lever(:,7,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV165',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV116,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV165,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus II
Model.Lever(:,8,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV175',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV126,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV175,[1,1,n]),Segment(5).Q)))];

% Gluteus minimus III
Model.Lever(:,9,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV185',[1,1,n]),....
    Vnorm_array3(Mprod_array3(repmat(NV136,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV185,[1,1,n]),Segment(5).Q)))];

% Adductor longus
Model.Lever(:,10,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV195',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV146,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV195,[1,1,n]),Segment(5).Q)))];

% Adductor brevis
Model.Lever(:,11,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV205',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV156,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV205,[1,1,n]),Segment(5).Q)))];

% Adductor magnus I
Model.Lever(:,12,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV215',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV166,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV215,[1,1,n]),Segment(5).Q)))];

% Adductor magnus II
Model.Lever(:,13,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV225',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV176,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV225,[1,1,n]),Segment(5).Q)))];

% Adductor magnus III
Model.Lever(:,14,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV235',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV186,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV235,[1,1,n]),Segment(5).Q)))];

% Pectineus
Model.Lever(:,15,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV245',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV196,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV245,[1,1,n]),Segment(5).Q)))];

% Iliacus
Model.Lever(:,16,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV255',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV216,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV255,[1,1,n]),Segment(5).Q)))];

% Psoas
Model.Lever(:,17,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV275',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV236,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q)))];

% Quadratus femoris
Model.Lever(:,18,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV295',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV246,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q)))];

% Gemellus
Model.Lever(:,19,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV305',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV256,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV305,[1,1,n]),Segment(5).Q)))];

% Piriformis
Model.Lever(:,20,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV315',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV276,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV315,[1,1,n]),Segment(5).Q)))];

% Tensor fasciae latae
Model.Lever(:,21,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV103',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV335,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV325',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV286,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q))) ...
    - Mprod_array3(repmat(NV335',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV335,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)))];

% Gracilis
Model.Lever(:,22,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV113',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV296,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV113,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Sartorius
Model.Lever(:,23,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV183',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV345,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV345',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV336,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV345,[1,1,n]),Segment(5).Q))) ...
    - Mprod_array3(repmat(NV345',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV345,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)))];

% Semimenbranosus
Model.Lever(:,24,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV133',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV306,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV133,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Semitendinosus
Model.Lever(:,25,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV143',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV316,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV143,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Biceps femoris long head
Model.Lever(:,26,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV173',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV326,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Biceps femoris short head
Model.Lever(:,27,1:n) = [zeros(12,1,n);...
    Mprod_array3(repmat(NV213',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV355,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV213,[1,1,n]),Segment(3).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Rectus femoris
Model.Lever(:,28,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV24',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV346,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV24,[1,1,n]),Segment(4).Q)));...
    zeros(12,1,n)];
% % Moving point in case of tibio-femoral angle < - 83.65 degrees
% ind = find(FE3 <= -83.65);
% if ~isempty(ind)
%     display(['Using via point V365 for rectus femoris at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,28,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV24',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV365',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV346,[1,1,ni]),Segment(6).Q(:,:,ind)) - Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)))) ...
%         - Mprod_array3(repmat(NV365',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus medialis
% Using V385 as virtual marker for origin
Model.Lever(:,29,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV34',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV385,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV385',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV385,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)))];
% % Using V395 as virtual marker for origin
% ind = find(FE3 <= -69.36 & FE3 > -102);
% if ~isempty(ind)
%     display(['Using origin V395 for vastus medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,29,ind) =  [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV34',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV395',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end
% % Using V405 as virtual marker for origin
% ind = find(FE3 <= -102);
% if ~isempty(ind)
%     display(['Using origin V405 for vastus medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,29,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV34',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV405,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV405',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV405,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus intermedialis
% Using V425 as virtual marker for origin
Model.Lever(:,30,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV44',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV425',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)))];
% % Using V435 as virtual marker for origin
% ind = find(FE3 <= -81.40);
% if ~isempty(ind)
%     display(['Using origin V435 for vastus intermedialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,30,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV44',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV435',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Vastus lateralis
% Using V455 as virtual marker for origin
Model.Lever(:,31,1:n) = [zeros(12,1,n);...
    zeros(12,1,n);...
    Mprod_array3(repmat(NV54',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV455,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)));...
    - Mprod_array3(repmat(NV455',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV455,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)))];
% % Using V465 as virtual marker for origin
% ind = find(FE3 <= -69.36 & FE3 > -110.60);
% if ~isempty(ind)
%     display(['Using origin V465 for vastus lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,31,ind) = [zeros(12,1,ni);...
%         zeros(12,1,ni);...
%         Mprod_array3(repmat(NV54',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV465',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end
% % Using V475 as virtual marker for origin
% ind = find(FE3 <= -110.60);
% if ~isempty(ind)
% %     display(['Using origin V475 for vastus lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,31,ind) = [zeros(3,1,ni);...
%         zeros(3,1,ni);...
%         Mprod_array3(repmat(NV54',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV475,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))));...
%         - Mprod_array3(repmat(NV475',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV475,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))))];
% end

% Gastrocnemius medialis
% Using V485 as virtual marker for via point in the thigh
Model.Lever(:,32,1:n) = [Mprod_array3(repmat(NV42',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)));...
    Mprod_array3(repmat(NV223',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV485,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q)) ...
    - Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    - Mprod_array3(repmat(NV485',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV485,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q)))];
% % Using V495 as virtual marker for via point in the thigh
% ind = find(FE3 > -44.14);
% if ~isempty(ind)
%     display(['Using via point V495 for gastrocnemius medialis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,32,ind) = [Mprod_array3(repmat(NV42',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV223',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV495,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind)))...
%         - Vnorm_array3(Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         zeros(12,1,ni);...
%         - Mprod_array3(repmat(NV495',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV495,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind))))];
% end

% Gastrocnemius lateralis       
% Using V505 as virtual marker for via point in the thigh
Model.Lever(:,33,1:n) = [Mprod_array3(repmat(NV52',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)));...
    Mprod_array3(repmat(NV233',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV505,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q)) ...
    - Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    - Mprod_array3(repmat(NV505',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV505,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q)))];
% % Using V515 as virtual marker for via point in the thigh
% ind = find(FE3 > -44.14);
% if ~isempty(ind)
%     display(['Using via point V515 for gastrocnemius lateralis at frames ',num2str(ind')])
%     ni = size(ind,1);
%     Model.Lever(:,33,ind) = [Mprod_array3(repmat(NV52',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         Mprod_array3(repmat(NV233',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV515,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind))) - ...
%         Vnorm_array3(Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))));...
%         zeros(12,1,ni);...
%         - Mprod_array3(repmat(NV515',[1,1,ni]),...
%         Vnorm_array3(Mprod_array3(repmat(NV515,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind))))];
% end

% Soleus
Model.Lever(:,34,1:n) = [Mprod_array3(repmat(NV62',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV243',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Tibialis posterior
Model.Lever(:,35,1:n) = [Mprod_array3(repmat(NV72',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV263',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Tibialis anterior
Model.Lever(:,36,1:n) = [Mprod_array3(repmat(NV102',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV283',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus brevis
Model.Lever(:,37,1:n) = [Mprod_array3(repmat(NV112',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV313,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV313',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV313,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus longus
Model.Lever(:,38,1:n) = [Mprod_array3(repmat(NV132',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV343,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV343',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV343,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Peroneus tertius
Model.Lever(:,39,1:n) = [Mprod_array3(repmat(NV172',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV363,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV172,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV363',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV363,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV172,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Extensor digitorum longus
Model.Lever(:,40,1:n) = [Mprod_array3(repmat(NV182',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV383,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV182,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV383',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV383,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV182,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Extensor hallucis longus
Model.Lever(:,41,1:n) = [Mprod_array3(repmat(NV222',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV403,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV222,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV403',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV403,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV222,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Flexor digitorum longus
Model.Lever(:,42,1:n) = [Mprod_array3(repmat(NV272',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV423,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV272,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV423',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV423,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV272,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% Flexor hallucis longus
Model.Lever(:,43,1:n) = [Mprod_array3(repmat(NV332',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV443,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV332,[1,1,n]),Segment(2).Q)));...
    - Mprod_array3(repmat(NV443',[1,1,n]),...
    Vnorm_array3(Mprod_array3(repmat(NV443,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV332,[1,1,n]),Segment(2).Q)));...
    zeros(12,1,n);...
    zeros(12,1,n)];

% -------------------------------------------------------------------------
% Musculo-tendon unit length
% -------------------------------------------------------------------------
% Initialisation
Model.Lmt = zeros(43,1,n);

% Gluteus maximus I
Model.Lmt(1,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV26,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV36,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV36,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV75,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV75,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV85,[1,1,n]),Segment(5).Q)).^2));

% Gluteus maximus II
Model.Lmt(2,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV46,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV56,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV56,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV95,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV95,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV105,[1,1,n]),Segment(5).Q)).^2));

% Gluteus maximus III
Model.Lmt(3,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV66,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV76,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV76,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV115,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV115,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV125,[1,1,n]),Segment(5).Q)).^2));

% Gluteus medius I
Model.Lmt(4,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV86,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV135,[1,1,n]),Segment(5).Q)).^2));

% Gluteus medius II
Model.Lmt(5,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV96,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV145,[1,1,n]),Segment(5).Q)).^2));

% Gluteus medius III
Model.Lmt(6,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV106,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV155,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus I
Model.Lmt(7,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV116,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV165,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus II
Model.Lmt(8,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV126,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV175,[1,1,n]),Segment(5).Q)).^2));

% Gluteus minimus III
Model.Lmt(9,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV136,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV185,[1,1,n]),Segment(5).Q)).^2));

% Adductus longus
Model.Lmt(10,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV146,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV195,[1,1,n]),Segment(5).Q)).^2));

% Adductus brevis
Model.Lmt(11,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV156,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV205,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus 1
Model.Lmt(12,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV166,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV215,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus 2
Model.Lmt(13,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV176,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV225,[1,1,n]),Segment(5).Q)).^2));

% Adductus magnus 3
Model.Lmt(14,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV186,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV235,[1,1,n]),Segment(5).Q)).^2));

% Pectineus
Model.Lmt(15,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV196,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV245,[1,1,n]),Segment(5).Q)).^2));

% Iliacus
Model.Lmt(16,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV206,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV216,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV216,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV255,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV255,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV265,[1,1,n]),Segment(5).Q)).^2));

% Psoas
Model.Lmt(17,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV226,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV236,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV236,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV275,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV285,[1,1,n]),Segment(5).Q)).^2));

% Quadratus femoris
Model.Lmt(18,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV246,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV295,[1,1,n]),Segment(5).Q)).^2));

% Gemelli
Model.Lmt(19,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV256,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV305,[1,1,n]),Segment(5).Q)).^2));

% Piriformis
Model.Lmt(20,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV266,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV276,[1,1,n]),Segment(6).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV276,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV315,[1,1,n]),Segment(5).Q)).^2));

% Tensor fascia lata
Model.Lmt(21,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV286,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV325,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV335,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV335,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV103,[1,1,n]),Segment(3).Q)).^2));

% Gracilis
Model.Lmt(22,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV296,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV113,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV113,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV123,[1,1,n]),Segment(3).Q)).^2));

% Sartorius
Model.Lmt(23,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV336,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV345,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV345,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV183,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV193,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV193,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV203,[1,1,n]),Segment(3).Q)).^2));

% Semimembranosus
Model.Lmt(24,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV306,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV133,[1,1,n]),Segment(3).Q)).^2));

% Semitendinosus
Model.Lmt(25,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV316,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV143,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV143,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV153,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV153,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV163,[1,1,n]),Segment(3).Q)).^2));

% Biceps femoris long head
Model.Lmt(26,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV326,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV173,[1,1,n]),Segment(3).Q)).^2));

% Biceps femoris short head
Model.Lmt(27,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV355,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV213,[1,1,n]),Segment(3).Q)).^2));

% Rectus femoris
Model.Lmt(28,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV346,[1,1,n]),Segment(6).Q) - Mprod_array3(repmat(NV24,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -83.65);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(28,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV346,[1,1,ni]),Segment(6).Q(:,:,ind)) - Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV365,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV24,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus medialis
Model.Lmt(29,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV375,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV385,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV385,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV34,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -69.36 & FE3 > -102);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(29,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV375,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end
% ind = find(FE3 <= -102);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(29,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV375,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV385,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV395,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV405,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV405,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV34,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus intermedius
Model.Lmt(30,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV415,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV425,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV44,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -81.4);
% if ~isempty(ind) 
%     ni = size(ind,1);
%     Model.Lmt(30,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV415,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV425,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV425,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV435,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV44,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Vastus lateralis
Model.Lmt(31,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV445,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV455,[1,1,n]),Segment(5).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV455,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV54,[1,1,n]),Segment(4).Q)).^2));
% ind = find(FE3 <= -69.36 & FE3 > -110.06);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(31,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV445,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV455,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV455,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end
% ind = find(FE3 <= -110.06);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(31,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV445,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV455,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV455,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV465,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV475,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV475,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV54,[1,1,ni]),Segment(4).Q(:,:,ind))).^2));
% end

% Gastrocnemius medialis
Model.Lmt(32,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV485,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV223,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV42,[1,1,n]),Segment(2).Q)).^2));
% ind = find(FE3 > -44.14);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(32,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV485,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV495,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV495,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV223,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV42,[1,1,ni]),Segment(2).Q(:,:,ind))).^2));
% end

% Gastrocnemius lateralis
Model.Lmt(33,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV505,[1,1,n]),Segment(5).Q) - Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV233,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV52,[1,1,n]),Segment(2).Q)).^2));
% ind = find(FE3 > -44.14);
% if ~isempty(ind)
%     ni = size(ind,1);
%     Model.Lmt(33,1,ind) = ...
%         sqrt(sum((Mprod_array3(repmat(NV505,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV515,[1,1,ni]),Segment(5).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV515,[1,1,ni]),Segment(5).Q(:,:,ind)) - Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind))).^2)) + ...
%         sqrt(sum((Mprod_array3(repmat(NV233,[1,1,ni]),Segment(3).Q(:,:,ind)) - Mprod_array3(repmat(NV52,[1,1,ni]),Segment(2).Q(:,:,ind))).^2));
% end

% Soleus
Model.Lmt(34,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV243,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV62,[1,1,n]),Segment(2).Q)).^2));

% Tibialis posterior
Model.Lmt(35,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV253,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV263,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV72,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV82,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV82,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV92,[1,1,n]),Segment(2).Q)).^2));

% Tibialis anterior
Model.Lmt(36,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV273,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV283,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV102,[1,1,n]),Segment(2).Q)).^2));

% Peroneus brevis
Model.Lmt(37,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV293,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV303,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV303,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV313,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV313,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV112,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV122,[1,1,n]),Segment(2).Q)).^2));

% Peroneus longus
Model.Lmt(38,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV323,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV333,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV333,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV343,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV343,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV132,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV142,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV142,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV152,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV152,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV162,[1,1,n]),Segment(2).Q)).^2));

% Peroneus tertius
Model.Lmt(39,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV353,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV363,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV363,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV172,[1,1,n]),Segment(2).Q)).^2));

% Extensor digitorum longus
Model.Lmt(40,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV373,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV383,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV383,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV182,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV182,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV192,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV192,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV202,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV202,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV212,[1,1,n]),Segment(2).Q)).^2));

% Extensor hallucis longus
Model.Lmt(41,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV393,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV403,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV403,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV222,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV222,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV232,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV232,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV242,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV242,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV252,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV252,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV262,[1,1,n]),Segment(2).Q)).^2));

% Flexor digitorum longus
Model.Lmt(42,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV413,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV423,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV423,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV272,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV272,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV282,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV282,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV292,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV292,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV302,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV302,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV312,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV312,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV322,[1,1,n]),Segment(2).Q)).^2));

% Flexor hallucis longus
Model.Lmt(43,1,1:n) = ...
    sqrt(sum((Mprod_array3(repmat(NV433,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV443,[1,1,n]),Segment(3).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV443,[1,1,n]),Segment(3).Q) - Mprod_array3(repmat(NV332,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV332,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV342,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV342,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV352,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV352,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV362,[1,1,n]),Segment(2).Q)).^2)) + ...
    sqrt(sum((Mprod_array3(repmat(NV362,[1,1,n]),Segment(2).Q) - Mprod_array3(repmat(NV372,[1,1,n]),Segment(2).Q)).^2));

% -------------------------------------------------------------------------
% Muscle fiber length
% Lmt = Lt + Lm * cos(pennation)
% We suppose here Lt = Lts (tendon slack length)
% -------------------------------------------------------------------------
for i = 1:43
    Model.Lt(i) = Model.Lts(i);
    Model.Lm(i,1,:) = Mprod_array3((Model.Lmt(i,1,:) - Model.Lt(i)), ...
        repmat(cos(Model.pennation(i))^(-1),[1,1,n]));
end

% -------------------------------------------------------------------------
% Muscle fiber stretch velocities
% -------------------------------------------------------------------------
Model.V = Derive_array3(Model.Lm,1/f);
